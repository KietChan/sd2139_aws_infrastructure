pipeline {
    agent any

    stages {
        stage('Front End Deployment') {
            steps {
                script {
                    // Call the API to get the token
                    def token = sh(script: '''
                        aws eks get-token --cluster-name my-eks-cluster --query 'status.token' --output text
                    ''', returnStdout: true).trim()

                    // Store the token as a temporary secret
                    withCredentials([string(credentialsId: 'eks-token', variable: 'TOKEN')]) {
                        // Set the token as an environment variable
                        env.TOKEN = token

                        // Use the token in the next steps
                        sh '''
                            kubectl config set-credentials eks-user --token=$TOKEN
                            aws eks update-kubeconfig --region ap-southeast-1 --name my-eks-cluster
                            kubectl config set-context --current --user=eks-user
                        '''
                    }
                }
            }
        }
    }
}
